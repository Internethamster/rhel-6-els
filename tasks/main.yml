---
# tasks file for rhel-6-els
- name: retrieve the rhel-6-els ami for the current region
  community.aws.ec2_ami_info:
    region: "{{ aws_inject.repo }}"
    aws_access_key: "{{ aws_inject.aws_access_key | default(omit) }}"
    aws_secret_key: "{{ aws_inject.aws_secret_key | default(omit) }}"
      filters:
        product-code: "{{ aws_inject.rhel6els.product-code }}"
        product-code-type: "{{ aws_inject.rhel6els.product-code-type | default('marketplace') }}"
  register: aws_inject.rhel6els.regional_amis
  
- name: Create snapshot 1 of the donor instance
  debug:
    msg "-*- TODO -*- wait: true"
- name: enumerate the extra volumes attached to the instance
  debug:
    msg: "-*- TODO -*- enumerate the extra volumes attached to the instance"
- name: Create a surrogate instance
  debug:
    msg: "-*- TODO -*- Create a surrogate instance"
  notify: set the instance id as a fact
    # (needed for stop/start action)
  notify: set the root_volume as a fact
    # (needed for snapshot actions)
- name: Create a rhel-6-els target instance
  debug:
    msg: "-*- TODO -*- Create a rhel-6-els target instance "
  name: Stop the rhel-6-els target instance
  debug:
    msg: "-*- TODO -*- Stop the rhel-6-els target instance"
- name: Detach the target instance root volume
  debug:
    msg: "-*- TODO -*-  Detach the target instance root volume"
  notify: -*- TODO -*- Attach target vol to surrogate
- name: Create donor volume 1 from snapshot 1
  debug:
    msg: "-*- TODO -*-  Create donor volume 1 from snapshot 1"
- name: Attach donor volume to surrogate instance
  debug:
    msg: "-*- TODO -*-  Attach donor volume to surrogate instance"
- name: Copy content from donor volume to target instance.
  debug:
    msg: "-*- TODO -*-  Copy content from donor volume to target instance."
- name: Destroy donor volume 1 from donor instance
  debug:
    msg: "-*- TODO -*-  Destroy donor volume 1 from donor instance"
- name: Stop donor instance for final snapshot
  debug:
    msg: "-*- TODO -*-  Stop donor instance for final snapshot"
  notify: -*- TODO -*- create snapshot 2 from donor root volume
  # (set timeout based on the maintenance window)
  notify: -*- TODO -*- Start instance to continue providing service
- name: Create donor volume 2 from snapshot 2
  debug:
    msg: "-*- TODO -*-  Create donor volume 2 from snapshot 2"
- name: Attach the donor volume 2 to the surrogate instance
  debug:
    msg: "-*- TODO -*-  Attach the donor volume 2 to the surrogate instance"
- name: dd the content from donor volume 2 to target vol
  debug:
    msg: "-*- TODO -*-  dd the content from donor volume 2 to target vol"
  # (set timeout based on the maintenance window)
  notify: detach the volumes from the surrogate
- name: terminate the surrogate instance
  debug:
    msg: "-*- TODO -*-  terminate the surrogate instance"
- name: attach the target volume to the target instance (rhel-6-els)
  debug:
    msg: "-*- TODO -*-  attach the target volume to the target instance (rhel-6-els)"
  notify: -*- TODO -*- register an image from the target instance
- name: Attach any additional volumes to the target instance
  debug:
    msg: "-*- TODO -*-  Attach any additional volumes to the target instance"
  notify: -*- TODO -*- Create Image from donor instance (no waiting)
- name: Start the target instance
  debug:
    msg: "-*- TODO -*-  Start the target instance
